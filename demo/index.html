<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ICE Demo</title>
    <link rel="stylesheet" href="demo.css" type="text/css" media="screen" />
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script type="text/javascript" src="/ice.min.js"></script>
    <script
      src="https://cdn.tiny.cloud/1/%VITE_TINYMCE_API_KEY%/tinymce/8/tinymce.min.js"
      referrerpolicy="origin"
    ></script>
  </head>
  <body>
    <div id="app">
      <div class="container">
        <h1>Ice Demo</h1>

        <p>
          Ice is a track changes implementation, built in javascript, for
          anything that is contenteditable on the web. The following are demos
          of Ice in action. You can check out the code on
          <a href="https://github.com/NYTimes/ice">github</a>.
        </p>
        <h3>Contenteditable</h3>
        <p>
          With some text editing management of your own, Ice can be initialized
          on any element that is contenteditable. The following is a makeshift
          editor, made out of a `div` element container and some `p` root
          blocks. The editor buttons use Ice's API to change the user being
          tracked and toggle the visibility of changes.
        </p>

        <div class="editor">
          <div class="control">
            <strong>Set User:</strong>
            <select onchange="setUser(this)">
              <option
                data-userid="1"
                data-username="Smitty Werbenjägermanjensen"
              >
                Smitty Werbenjägermanjensen
              </option>
              <option data-userid="22" data-username="Chuck Noblet">
                Chuck Noblet
              </option>
              <option data-userid="33" data-username="Jerri Blank">
                Jerri Blank
              </option>
            </select>
          </div>
          <div class="control">
            <strong>Options:</strong>
            <button onclick="toggleDel(this)">Show/Hide Changes</button>
          </div>
          <div>
            <div class="control">
              <strong>Style:</strong>
              <button onclick="document.execCommand('bold', null, false);">
                <strong>B</strong>
              </button>
              <button onclick="document.execCommand('italic', null, false);">
                <em>i</em>
              </button>
              <button onclick="document.execCommand('underline', null, false);">
                <u>u</u>
              </button>
            </div>
            <div class="control">
              <strong>Indent:</strong>
              <button
                onclick="document.execCommand('formatBlock', null, '<h2>');"
              >
                H
              </button>
              <button
                onclick="document.execCommand('formatBlock', null, '<p>');"
              >
                p
              </button>
              <button
                onclick="document.execCommand('formatBlock', null, '<blockquote>');"
              >
                &quot;
              </button>
            </div>
            <div class="control">
              <strong>List:</strong>
              <button onclick="document.execCommand('indent', null, false);">
                &gt;
              </button>
              <button onclick="document.execCommand('outdent', null, false);">
                &lt;
              </button>
            </div>

            <div class="control">
              <strong>List:</strong>
              <button
                onclick="document.execCommand('InsertUnorderedList', null, false);"
              >
                UL
              </button>
              <button
                onclick="document.execCommand('InsertOrderedList', null, false);"
              >
                OL
              </button>
            </div>
            <div class="control">
              <strong>Insert:</strong>
              <button onclick="insertSampleImage();">Sample image</button>
            </div>
          </div>

          <div id="content">
            <div id="text-wrapper">
              <div id="textbody" data-testid="editor">
                <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit.</p>
                <p>Praesent facilisis sed nisi nec mattis.</p>
                <p>Aliquam nulla turpis, lobortis a gravida nec, rutrum id lorem.</p>
                <p>Ut malesuada odio condimentum scelerisque gravida.</p>
                <p>Morbi vitae leo at dolor semper porttitor.</p>
              </div>
            </div>
          </div>
        </div>

        <script type="text/javascript">
          document.addEventListener("DOMContentLoaded", () => {
            const text = document.getElementById("textbody");
            window.tracker = new ice.InlineChangeEditor({
              element: text,
              handleEvents: true,
              currentUser: { id: 1, name: "Smitty Werbenjägermanjensen" },
              plugins: [
                "IceAddTitlePlugin",
                "IceSmartQuotesPlugin",
                "IceEmdashPlugin",
                {
                  name: "IceCopyPastePlugin",
                  settings: {
                    pasteType: "formattedClean",
                    preserve: "p,a[href],i,em,b,span,ul,ol,li,hr",
                  },
                },
              ],
            }).startTracking();
          });

          window.setUser = (el) => {
            const selected = el.options[el.selectedIndex];
            const name = selected.getAttribute("data-username");
            const id = selected.getAttribute("data-userid");
            tracker.setCurrentUser({ id, name });
          };

          window.toggleDel = (el) => {
            const body = document.getElementById("textbody");
            if (body.classList.contains("CT-hide")) {
              body.classList.remove("CT-hide");
            } else {
              body.classList.add("CT-hide");
            }
          };

          window.insertSampleImage = () => {
            const range = tracker.getCurrentRange();
            if (!ice.dom.isChildOf(range.startContainer, text)) return false;
            const image = document.createElement("img");
            image.src =
              "http://graphics8.nytimes.com/images/2012/01/15/business/ONEPERCENT/ONEPERCENT-popup.jpg";
            image.width = 160;
            tracker.insert(image, range);
            text.focus();
          };
        </script>

        <h3>Tinymce Plugin</h3>
        <p>
          With tinymce handling the text editing, Ice can initialize and operate
          in a more configurable editing environment. Notice, the last six
          buttons in the toolbar can be toggled to modify changes or the state
          of Ice. In addition, this example shows off the ease in customizing
          and plugging in styles for tracking tags with a highlighter style
          contributed by Andrew Ozz at Wordpress. Since Andrew's style only uses
          two colors, one for inserts and one for deletes, you can hover over
          changes to get a title popup with more information about the user for
          a change.
        </p>

        <div class="editor">
          <div class="control">
            <strong>Set User:</strong>
            <select onchange="setUserMCE(this)">
              <option
                data-userid="1"
                data-username="Smitty Werbenjägermanjensen"
              >
                Smitty Werbenjägermanjensen
              </option>
              <option data-userid="22" data-username="Chuck Noblet">
                Chuck Noblet
              </option>
              <option data-userid="33" data-username="Jerri Blank">
                Jerri Blank
              </option>
            </select>
          </div>
          <div id="content">
            <div id="tinymce-wrapper">
              <textarea id="tinymce" style="width: 100%">
                <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit.</p>
                <p>Praesent facilisis sed nisi nec mattis.</p>
                <p>Aliquam nulla turpis, lobortis a gravida nec, rutrum id lorem.</p>
                <p>Ut malesuada odio condimentum scelerisque gravida.</p>
                <p>Morbi vitae leo at dolor semper porttitor.</p>
              </textarea>
            </div>
          </div>
        </div>

        <script type="text/javascript">
          tinymce.init({
            // Mandatory
            selector: "textarea#tinymce",

            toolbar1:
              "bold italic underline | bullist numlist | undo redo code | search replace",

            // Customizations
            height: "400",

            // Plugins
            external_plugins: {
              ice: "/tinymce/plugins/ice/plugin.min.js",
              icesearchreplace:
                "/tinymce/plugins/icesearchreplace/plugin.min.js",
            },
            plugins: "searchreplace ice icesearchreplace",
            toolbar2:
              "ice_search | ice_togglechanges | ice_toggleshowchanges | ice_acceptall ice_rejectall | ice_accept ice_reject",

            // ICE configuration
            ice: {
              user: { name: "Smitty Werbenjägermanjensen", id: 1 },
              preserveOnPaste: "p,a[href],i,em,b,span",
              preventScrollOnFocus: true,
              deleteTag: "delete",
              insertTag: "insert",
            },
          });

          window.setUserMCE = (el) => {
            const selected = el.options[el.selectedIndex];
            const name = selected.getAttribute("data-username");
            const id = selected.getAttribute("data-userid");
            tinymce.execCommand("ice_changeuser", { id, name });
          };
        </script>
      </div>
    </div>
  </body>
</html>
